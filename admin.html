<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Keuangan Admin - Uang Masuk & Uang Keluar</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .filter-container { margin-top: 20px; }
    .filter-container input { padding: 8px; margin-right: 10px; }
    .total-container { margin-top: 20px; font-size: 18px; }
    .button-container { margin-top: 20px; }
    .button-container button { padding: 8px 12px; margin-right: 10px; cursor: pointer; }
    .form-container { margin-top: 20px; }
    .form-container input, .form-container textarea, .form-container button {
      padding: 8px;
      margin-right: 10px;
      margin-top: 10px;
      display: block;
    }
  </style>
</head>
<body>
  <h1>Laporan Keuangan Admin - Uang Masuk & Uang Keluar</h1>

  <!-- Form Input untuk Data Transaksi -->
  <div class="form-container">
    <h3>Tambah Transaksi</h3>
    <form id="transaksiForm">
      <label for="tanggal">Tanggal:</label>
      <input type="date" id="tanggal" required>

      <label for="uangMasuk">Uang Masuk (IDR):</label>
      <input type="number" id="uangMasuk" required>

      <label for="uangKeluar">Uang Keluar (IDR):</label>
      <input type="number" id="uangKeluar" required>

      <label for="keterangan">Keterangan:</label>
      <textarea id="keterangan" required></textarea>

      <button type="submit">Kirim Data</button>
    </form>
  </div>

  <!-- Filter berdasarkan Tanggal -->
  <div class="filter-container">
    <input type="date" id="filterTanggal">
  </div>

  <div class="button-container">
    <button onclick="fetchTransaksi()">Pencarian</button>
    <button onclick="clearFilters()">Clear</button>
  </div>

  <table id="laporanTable">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Uang Masuk</th>
        <th>Uang Keluar</th>
        <th>Keterangan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="total-container">
    <strong>Total Uang Masuk: Rp <span id="totalUangMasuk">0</span></strong><br>
    <strong>Total Uang Keluar: Rp <span id="totalUangKeluar">0</span></strong>
  </div>

  <script>
    let allTransaksi = []; // Untuk menyimpan data transaksi

    // Fungsi untuk mengambil data transaksi dari Google Apps Script
    function fetchTransaksi() {
      const tanggalFilter = document.getElementById("filterTanggal").value;

      // Jika data belum diambil, ambil data dari Google Sheets
      if (allTransaksi.length === 0) {
        fetch('https://script.google.com/macros/s/AKfycbzW_ENAXCeoZ66ob0CRdyat9moeIgY6NoIyLoVV9AVmSh33C5ZZB-iaZSO1lLLtqaRk/exec?action=uangMasukKeluar')
          .then(response => response.json())
          .then(data => {
            allTransaksi = data;
            displayData(data, tanggalFilter);
          })
          .catch(error => console.error('Error fetching data:', error));
      } else {
        // Jika data sudah ada, langsung tampilkan dengan filter
        displayData(allTransaksi, tanggalFilter);
      }
    }

    // Fungsi untuk menampilkan data transaksi sesuai filter
    function displayData(data, tanggalFilter) {
      const tbody = document.querySelector("#laporanTable tbody");
      tbody.innerHTML = "";
      let totalUangMasuk = 0;
      let totalUangKeluar = 0;

      data.forEach(row => {
        const tanggal = formatDate(row[0]);
        const uangMasuk = parseFloat(row[1]);
        const uangKeluar = parseFloat(row[2]);
        const keterangan = row[3];

        // Filter berdasarkan Tanggal
        if (
          tanggalFilter === "" || tanggal === formatDate(tanggalFilter)
        ) {
          const tr = document.createElement("tr");

          // Format dan masukkan data ke dalam tabel
          const formattedUangMasuk = formatCurrency(uangMasuk);
          const formattedUangKeluar = formatCurrency(uangKeluar);
          tr.innerHTML = `
            <td>${tanggal}</td>
            <td>${formattedUangMasuk}</td>
            <td>${formattedUangKeluar}</td>
            <td>${keterangan}</td>
          `;

          tbody.appendChild(tr);
          totalUangMasuk += uangMasuk;
          totalUangKeluar += uangKeluar;
        }
      });

      // Update total uang masuk dan keluar dengan format IDR
      document.getElementById("totalUangMasuk").textContent = formatCurrency(totalUangMasuk);
      document.getElementById("totalUangKeluar").textContent = formatCurrency(totalUangKeluar);
    }

    // Fungsi untuk memformat tanggal menjadi dd-mm-yyyy
    function formatDate(date) {
      const d = new Date(date);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}-${month}-${year}`;
    }

    // Fungsi untuk memformat jumlah uang menjadi IDR
    function formatCurrency(amount) {
      return `Rp ${amount.toLocaleString('id-ID')}`;
    }

    // Fungsi untuk menghapus filter
    function clearFilters() {
      document.getElementById("filterTanggal").value = "";
      displayData(allTransaksi, "");
    }

    // Fungsi untuk menangani form submission dan kirim data ke Google Sheets
    document.getElementById("transaksiForm").addEventListener("submit", function (event) {
      event.preventDefault();

      // Ambil nilai input dari form
      const tanggal = document.getElementById("tanggal").value;
      const uangMasuk = parseFloat(document.getElementById("uangMasuk").value);
      const uangKeluar = parseFloat(document.getElementById("uangKeluar").value);
      const keterangan = document.getElementById("keterangan").value;

      // Kirim data ke Google Apps Script
      fetch('https://script.google.com/macros/s/AKfycbzW_ENAXCeoZ66ob0CRdyat9moeIgY6NoIyLoVV9AVmSh33C5ZZB-iaZSO1lLLtqaRk/exec', {
        method: 'POST',
        body: JSON.stringify({
          action: 'tambahLaporan',
          tanggal: tanggal,
          uangMasuk: uangMasuk,
          uangKeluar: uangKeluar,
          keterangan: keterangan
        })
      })
      .then(response => response.text())
      .then(data => {
        alert("Data berhasil dikirim!");
        fetchTransaksi(); // Ambil data terbaru
        document.getElementById("transaksiForm").reset(); // Reset form input
      })
      .catch(error => {
        console.error('Error:', error);
        alert("Terjadi kesalahan, coba lagi.");
      });
    });

    // Load data saat halaman dimuat
    window.onload = fetchTransaksi;
  </script>
</body>
</html>
