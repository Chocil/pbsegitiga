<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Laporan Keuangan</title>
  <style>
/* Reset dan Umum */
body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #f4f6f9;
  padding: 20px;
  margin: auto;
  max-width: 900px;
}

/* Judul */
h2, h3 {
  text-align: center;
  color: #333;
  margin-bottom: 20px;
}

/* Container Form */
.form-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.form-container > * {
  flex: 1 1 100%;
}

/* Input dan Select */
input, select {
  padding: 8px;
  font-size: 0.9em;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
  width: 100%;
}

/* Tombol */
button {
  padding: 8px;
  font-size: 0.9em;
  background-color: #007BFF;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background-color: #0056b3;
}

/* Tombol Kembali */
.back-button {
  display: inline-block;
  margin-bottom: 15px;
  padding: 8px 12px;
  background-color: #6c757d;
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.9em;
  transition: background-color 0.3s ease;
}

.back-button:hover {
  background-color: #5a6268;
}

/* Tabel Responsif */
.table-wrapper {
  overflow-x: auto;
  width: 100%;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 6px;
  font-size: 0.85em;
  min-width: 500px;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
  text-align: left;
  white-space: nowrap;
}

th {
  background: #007BFF;
  color: white;
}

/* Tombol Aksi */
.action-btns {
  display: flex;
  justify-content: center;
  gap: 6px;
}

.edit-btn, .delete-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.edit-btn img, .delete-btn img {
  width: 16px;
  height: 16px;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 10;
}

.modal-content {
  background-color: white;
  padding: 15px;
  border-radius: 8px;
  width: 90%;
  max-width: 380px;
}

.modal-header {
  font-size: 1.2em;
  margin-bottom: 15px;
  text-align: center;
}

.modal-footer {
  text-align: right;
  margin-top: 10px;
}

.close-btn {
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
}

.close-btn:hover {
  background-color: #c82333;
}

/* Media Queries */
@media (min-width: 600px) {
  .form-container > input,
  .form-container > select {
    flex: 1 1 calc(25% - 10px);
  }

  .form-container > button {
    flex: 1 1 100%;
    max-width: 200px;
    align-self: flex-end;
  }

  table {
    font-size: 0.9em;
  }

  th, td {
    padding: 10px;
  }
}
/* Tabel Responsif */
.table-wrapper {
  overflow-x: auto;
  width: 100%;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 6px;
  font-size: 0.72em; /* Ukuran font diperkecil */
  min-width: 400px;
}

th, td {
  padding: 4px 6px; /* Padding lebih sempit */
  border-bottom: 1px solid #ddd;
  text-align: left;
  white-space: nowrap;
}

th {
  background: #007BFF;
  color: white;
  font-size: 0.75em;
}

/* Tombol Aksi */
.action-btns {
  display: flex;
  justify-content: center;
  gap: 4px;
}

.edit-btn, .delete-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 2px;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.edit-btn img, .delete-btn img {
  width: 12px;
  height: 12px;
}

/* Input & Button Ukuran Kecil */
input, select {
  padding: 6px;
  font-size: 0.75em;
  border-radius: 4px;
}

button {
  padding: 6px;
  font-size: 0.75em;
  border-radius: 4px;
}

/* Modal Lebih Ramping */
.modal-content {
  padding: 12px;
  width: 95%;
  max-width: 340px;
  font-size: 0.8em;
}

.modal-header {
  font-size: 1em;
}

/* Kembali dan Modal Close */
.back-button,
.close-btn {
  font-size: 0.75em;
  padding: 5px 8px;
  border-radius: 4px;
}

/* Media Queries (Sedikit lebih besar untuk tablet) */
@media (min-width: 600px) {
  table {
    font-size: 0.8em;
  }

  th, td {
    padding: 6px 8px;
  }
}


  </style>
</head>
<body>
  <h2>Laporan Keuangan</h2>

  <input type="date" id="tanggal" />
  <input type="text" id="keterangan" placeholder="Keterangan" />
  <input type="text" id="jumlah" placeholder="Jumlah" />
  <select id="jenis">
    <option value="Masuk">Uang Masuk</option>
    <option value="Keluar">Uang Keluar</option>
  </select>
  <button id="submitButton" onclick="submitData()">Tambah Transaksi</button>

  <h3>Riwayat Transaksi</h3>
  <button onclick="openRekapModal()">Rekap</button>
  <a href="index.html" class="back-button">Halaman Utama</a>

  <table id="tabel">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Keterangan</th>
        <th>Jumlah</th>
        <th>Jenis</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal Edit -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Edit Transaksi</div>
      <input type="date" id="modal-tanggal" />
      <input type="text" id="modal-keterangan" placeholder="Keterangan" />
      <input type="text" id="modal-jumlah" placeholder="Jumlah" />
      <select id="modal-jenis">
        <option value="Masuk">Uang Masuk</option>
        <option value="Keluar">Uang Keluar</option>
      </select>
      <div class="modal-footer">
        <button class="close-btn" onclick="closeModal()">Batal</button>
        <button onclick="updateTransaction()">Update</button>
      </div>
    </div>
  </div>

  <!-- Modal Rekap -->
  <div id="rekap-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Rekapitulasi Keuangan</div>
      <p><strong>Total Masuk:</strong> <span id="rekap-masuk">Rp0</span></p>
      <p><strong>Total Keluar:</strong> <span id="rekap-keluar">Rp0</span></p>
      <p><strong>Total Kas:</strong> <span id="rekap-kas">Rp0</span></p>
      <div class="modal-footer">
        <button class="close-btn" onclick="closeRekapModal()">Tutup</button>
      </div>
    </div>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw_Ginq1mLM2xzdD2eryqrkxzlL5RUsk553OODE8cN3G9A9fQU-82bdErkqG0KDwWTuWg/exec';

    document.getElementById("jumlah").addEventListener("input", function(e) {
      let value = e.target.value.replace(/[^\d]/g, '');
      value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      e.target.value = value;
    });

    async function submitData() {
      const submitButton = document.getElementById("submitButton");
      submitButton.disabled = true;

      const tanggal = document.getElementById("tanggal").value;
      const keterangan = document.getElementById("keterangan").value;
      let jumlah = document.getElementById("jumlah").value.replace(/\./g, '');
      const jenis = document.getElementById("jenis").value;

      if (!tanggal || !keterangan || !jumlah) {
        alert("Semua kolom harus diisi.");
        submitButton.disabled = false;
        return;
      }

      try {
        await fetch(`${scriptURL}?action=addTransaction&tanggal=${encodeURIComponent(tanggal)}&keterangan=${encodeURIComponent(keterangan)}&jumlah=${encodeURIComponent(jumlah)}&jenis=${encodeURIComponent(jenis)}`);
        alert("Transaksi berhasil ditambahkan!");
        document.getElementById("tanggal").value = "";
        document.getElementById("keterangan").value = "";
        document.getElementById("jumlah").value = "";
        document.getElementById("jenis").value = "Masuk";
        loadData();
      } catch (error) {
        alert("Terjadi kesalahan saat menambahkan transaksi.");
      }

      submitButton.disabled = false;
    }

    async function loadData() {
      const res = await fetch(`${scriptURL}?action=getData`);
      const data = await res.json();

      data.sort((a, b) => new Date(b[0]) - new Date(a[0]));

      const tbody = document.querySelector("#tabel tbody");
      tbody.innerHTML = "";
      data.forEach((row, index) => {
        const tr = document.createElement("tr");

        row[0] = formatDate(row[0]);
        row[2] = formatCurrency(row[2]);

        row.forEach((cell, i) => {
          const td = document.createElement("td");
          td.textContent = cell;
          if (i === 3) td.style.color = cell === "Masuk" ? "green" : "red";
          tr.appendChild(td);
        });

        const tdActions = document.createElement("td");
        tdActions.classList.add("action-btns");

        const editBtn = document.createElement("button");
        editBtn.classList.add("edit-btn");
        editBtn.innerHTML = '<img src="image/pen.png" alt="Edit">';
        editBtn.onclick = () => openModal(index, row);

        const deleteBtn = document.createElement("button");
        deleteBtn.classList.add("delete-btn");
        deleteBtn.innerHTML = '<img src="image/trash.png" alt="Hapus">';
        deleteBtn.onclick = () => confirmDelete(index);

        tdActions.appendChild(editBtn);
        tdActions.appendChild(deleteBtn);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}-${month}-${year}`;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(amount);
    }

    async function deleteTransaction(index) {
      await fetch(`${scriptURL}?action=deleteTransaction&id=${index}`);
      loadData();
      alert("Data berhasil dihapus.");
    }

    function confirmDelete(index) {
      if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
        deleteTransaction(index);
      }
    }

    function openModal(index, rowData) {
      const tanggal = rowData[0].split('-').reverse().join('-');
      document.getElementById("modal-tanggal").value = tanggal;
      document.getElementById("modal-keterangan").value = rowData[1];
      document.getElementById("modal-jumlah").value = rowData[2].replace(/[^\d]/g, '');
      document.getElementById("modal-jenis").value = rowData[3];
      document.getElementById("modal").style.display = "flex";
      document.getElementById("modal").dataset.index = index;
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    async function updateTransaction() {
      const index = document.getElementById("modal").dataset.index;
      const tanggal = document.getElementById("modal-tanggal").value;
      const keterangan = document.getElementById("modal-keterangan").value;
      let jumlah = document.getElementById("modal-jumlah").value.replace(/\./g, '');
      const jenis = document.getElementById("modal-jenis").value;

      await fetch(`${scriptURL}?action=updateTransaction&id=${index}&tanggal=${encodeURIComponent(tanggal)}&keterangan=${encodeURIComponent(keterangan)}&jumlah=${encodeURIComponent(jumlah)}&jenis=${encodeURIComponent(jenis)}`);

      alert("Data berhasil diubah.");
      closeModal();
      loadData();
    }

    function openRekapModal() {
      const rows = document.querySelectorAll("#tabel tbody tr");
      let totalMasuk = 0, totalKeluar = 0;

      rows.forEach(row => {
        const jumlahText = row.children[2].textContent.replace(/[^\d]/g, '');
        const jumlah = parseInt(jumlahText) || 0;
        const jenis = row.children[3].textContent;

        if (jenis === "Masuk") totalMasuk += jumlah;
        if (jenis === "Keluar") totalKeluar += jumlah;
      });

      document.getElementById("rekap-masuk").textContent = formatCurrency(totalMasuk);
      document.getElementById("rekap-keluar").textContent = formatCurrency(totalKeluar);
      document.getElementById("rekap-kas").textContent = formatCurrency(totalMasuk - totalKeluar);
      document.getElementById("rekap-modal").style.display = "flex";
    }

    function closeRekapModal() {
      document.getElementById("rekap-modal").style.display = "none";
    }

    loadData();
  </script>
</body>
</html>
